<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallery | #MSG_commu</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <audio id="main-audio" loop><source id="audio-source" src="music/sukisugi_vocal.mp3" type="audio/mp3"></audio>

    <div class="music-controls" id="music-container">
        <span id="track-label" class="track-info">Vocal Ver.</span>
        <button id="play-btn" class="icon-btn"><img id="play-img" src="images/pause.png" alt="Play/Pause"></button>
    </div>

    <nav class="navbar">
        <div class="navbar-container">
            <ul class="navbar-menu">
                <li><a href="index.html" class="nav-link">Character</a></li>
                <li><a href="gallery.html" class="nav-link active">Gallery</a></li>
                <li><a href="ost.html" class="nav-link">OST/Voice</a></li>
                <li><a href="story.html" class="nav-link">Story</a></li>
            </ul>
        </div>
    </nav>

    <div id="app-content">
        <main class="gallery-content">
            <h1>Gallery</h1>
            <div class="gallery-grid" id="galleryGrid">
                <p style="grid-column: 1 / -1;">กำลังโหลดรูปภาพจากระบบ...</p>
            </div>
        </main>
    </div>

    <div id="lightbox" class="lightbox" onclick="closeImage()">
        <span class="close-lightbox">&times;</span>
        <img id="lightbox-img" src="" alt="Full view">
    </div>

    <script>
        const audio = document.getElementById('main-audio');
        const source = document.getElementById('audio-source');
        const playBtn = document.getElementById('play-btn');
        const playImg = document.getElementById('play-img');
        const musicContainer = document.getElementById('music-container');
        const label = document.getElementById('track-label');
        let isVocal = true;

        // ✨ ปรับลดระดับเสียงเพลงลงเหลือ 10% ตามที่ขอครับ ✨
        if(audio) audio.volume = 0.1;

        function updatePlayBtn() { if(playImg) playImg.src = audio.paused ? "images/play.png" : "images/pause.png"; }

        if(musicContainer) {
            musicContainer.addEventListener('click', (e) => {
                if (e.target.closest('#play-btn')) return;
                const currentTime = audio.currentTime;
                isVocal = !isVocal;
                source.src = isVocal ? "music/sukisugi_vocal.mp3" : "music/sukisugi_off.mp3";
                label.innerText = isVocal ? "Vocal Ver." : "Off Vocal";
                musicContainer.style.backgroundColor = isVocal ? "#FFF7E6" : "#6FCCD9";
                audio.load(); audio.currentTime = currentTime; audio.play();
                updatePlayBtn();
            });
        }

        if(playBtn) {
            playBtn.addEventListener('click', (e) => { e.stopPropagation(); if (audio.paused) audio.play(); else audio.pause(); updatePlayBtn(); });
        }

        function setupAnimations() {
            const flipCards = document.querySelectorAll('.idcard-wrapper');
            const liftCards = document.querySelectorAll('.hover-lift-container');
            const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
            if (isTouch) {
                flipCards.forEach(el => el.addEventListener('click', function() { this.classList.toggle('is-flipped'); }));
                liftCards.forEach(el => el.addEventListener('click', function() { this.classList.toggle('is-lifted'); }));
            }
        }

        // --- ✨ ฟังก์ชันควบคุม Popup รูปภาพ ✨ ---
        function openImage(src) {
            const lightbox = document.getElementById('lightbox');
            const lightboxImg = document.getElementById('lightbox-img');
            if(lightbox && lightboxImg) {
                lightboxImg.src = src;
                lightbox.classList.add('active');
                document.body.style.overflow = 'hidden'; // ปิดการ scroll ของหน้าเว็บเวลาดูรูป
            }
        }

        function closeImage() {
            const lightbox = document.getElementById('lightbox');
            if(lightbox) {
                lightbox.classList.remove('active');
                document.body.style.overflow = 'auto'; // เปิดการ scroll กลับมา
            }
        }

        // --- ฟังก์ชันดึงรูปภาพจาก Google Sheets ---
        const sheetCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTq0BFHKVSCUHbzjS-GPCLoggKXpeAecEMsj9yn4lZArfBZk6I6RzxfuM88cos9ifd2UGJdKguUX_w4/pub?output=csv"; 
        async function loadGallery() {
            const grid = document.getElementById('galleryGrid');
            if (!grid) return;
            try {
                const response = await fetch(sheetCsvUrl + "&t=" + new Date().getTime());
                const data = await response.text();
                const rows = data.split('\n').slice(1);
                grid.innerHTML = ''; 
                rows.forEach(row => {
                    if (row.trim() === '') return; 
                    const columns = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    if (columns.length >= 2) {
                        const artist = columns[0].replace(/^"|"$/g, '').trim();
                        const url = columns[1].replace(/^"|"$/g, '').trim();
                        if(url && url.startsWith('http')) {
                            const item = document.createElement('div');
                            item.className = 'gallery-item';
                            // ✨ เพิ่ม onclick="openImage('${url}')" เพื่อให้กดดูรูปใหญ่ได้ ✨
                            item.innerHTML = `
                                <img src="${url}" alt="Artwork by ${artist}" style="cursor: zoom-in;" onclick="openImage('${url}')" onerror="this.src='https://placehold.co/400x600?text=Image+Error'">
                                <div class="artist-tag">By <span class="artist-name">${artist}</span></div>
                            `;
                            grid.appendChild(item);
                        }
                    }
                });
            } catch (error) { 
                grid.innerHTML = '<p>ไม่สามารถดึงข้อมูลรูปภาพได้</p>'; 
                console.error("Gallery Load Error:", error);
            }
        }

        // --- ระบบ SPA ---
        document.addEventListener('click', e => {
            const link = e.target.closest('.nav-link');
            if (link) {
                e.preventDefault();
                const url = link.getAttribute('href');
                if (url && url !== "#") loadPage(url);
            }
        });

        async function loadPage(url) {
            const content = document.querySelector('#app-content');
            if(!content) return;
            
            // ปิด Popup เผื่อมีการกดลิงก์ตอนที่ดูรูปอยู่
            closeImage();

            content.classList.add('page-loading');
            await new Promise(r => setTimeout(r, 400));
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error("Fetch failed");
                const html = await res.text();
                const doc = new DOMParser().parseFromString(html, 'text/html');
                const newContent = doc.querySelector('#app-content');
                if (newContent) {
                    content.innerHTML = newContent.innerHTML;
                    window.history.pushState({}, '', url);
                    document.querySelectorAll('.nav-link').forEach(l => {
                        l.classList.remove('active');
                        if (url.includes(l.getAttribute('href'))) l.classList.add('active');
                    });
                    document.body.style.overflow = 'auto';
                    
                    if (url.includes('gallery.html')) loadGallery();
                    if (url.includes('index.html')) setupAnimations();
                    
                    content.classList.remove('page-loading');
                    window.scrollTo(0, 0);
                } else {
                    window.location.href = url;
                }
            } catch (err) { 
                console.error("SPA Error: Switching to normal load.", err); 
                window.location.href = url; 
            }
        }

        // เริ่มต้นการทำงานเมื่อเข้าหน้านี้
        loadGallery();
        setupAnimations();
        window.onpopstate = () => loadPage(window.location.href);
    </script>
</body>
</html>